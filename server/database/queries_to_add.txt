export const apartmentQueries = {
  /**
   * Создать новое объявление о квартире/апартаменте
   */
  create: (propertyData) => {
    const db = getDatabase();
    
    // Формируем JSON массив удобств из отдельных полей
    const amenities = [];
    if (propertyData.balcony) amenities.push('balcony');
    if (propertyData.parking) amenities.push('parking');
    if (propertyData.elevator) amenities.push('elevator');
    if (propertyData.electricity) amenities.push('electricity');
    if (propertyData.internet) amenities.push('internet');
    if (propertyData.security) amenities.push('security');
    if (propertyData.furniture) amenities.push('furniture');
    
    // Добавляем feature поля в массив удобств
    for (let i = 1; i <= 26; i++) {
      const featureKey = `feature${i}`;
      if (propertyData[featureKey]) {
        amenities.push(featureKey);
      }
    }
    
    const stmt = db.prepare(`
      INSERT INTO properties_apartments (
        user_id, property_type, title, description, price, currency,
        is_auction, auction_start_date, auction_end_date, auction_starting_price,
        area, living_area, building_type, rooms, bathrooms, floor, total_floors, year_built,
        location, address, apartment, country, city, coordinates,
        amenities, renovation, condition, heating, water_supply, sewerage,
        commercial_type, business_hours, additional_amenities,
        photos, videos, additional_documents,
        ownership_document, no_debts_document,
        test_drive, test_drive_data,
        moderation_status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `);
    
    return stmt.run(
      propertyData.user_id,
      propertyData.property_type,
      propertyData.title,
      propertyData.description || null,
      propertyData.price || null,
      propertyData.currency || 'USD',
      propertyData.is_auction ? 1 : 0,
      propertyData.auction_start_date || null,
      propertyData.auction_end_date || null,
      propertyData.auction_starting_price || null,
      propertyData.area || null,
      propertyData.living_area || null,
      propertyData.building_type || null,
      propertyData.rooms || null,
      propertyData.bathrooms || null,
      propertyData.floor || null,
      propertyData.total_floors || null,
      propertyData.year_built || null,
      propertyData.location || null,
      propertyData.address || null,
      propertyData.apartment || null,
      propertyData.country || null,
      propertyData.city || null,
      propertyData.coordinates ? JSON.stringify(propertyData.coordinates) : null,
      JSON.stringify(amenities),
      propertyData.renovation || null,
      propertyData.condition || null,
      propertyData.heating || null,
      propertyData.water_supply || null,
      propertyData.sewerage || null,
      propertyData.commercial_type || null,
      propertyData.business_hours || null,
      propertyData.additional_amenities || null,
      propertyData.photos ? JSON.stringify(propertyData.photos) : null,
      propertyData.videos ? JSON.stringify(propertyData.videos) : null,
      propertyData.additional_documents ? JSON.stringify(propertyData.additional_documents) : null,
      propertyData.ownership_document || null,
      propertyData.no_debts_document || null,
      propertyData.test_drive ? 1 : 0,
      propertyData.test_drive_data ? JSON.stringify(propertyData.test_drive_data) : null,
      propertyData.moderation_status || 'pending'
    );
  },

  /**
   * Получить квартиру по ID
   */
  getById: (id) => {
    const db = getDatabase();
    const stmt = db.prepare('SELECT * FROM properties_apartments WHERE id = ?');
    const property = stmt.get(id);
    
    if (property) {
      // Парсим JSON поля с безопасной обработкой ошибок
      if (property.amenities) {
        try {
          property.amenities = JSON.parse(property.amenities);
        } catch (e) {
          console.warn('⚠️ Ошибка парсинга amenities для property ID', id, ':', e.message);
          property.amenities = [];
        }
      }
      if (property.coordinates) {
        try {
          property.coordinates = JSON.parse(property.coordinates);
        } catch (e) {
          console.warn('⚠️ Ошибка парсинга coordinates для property ID', id, ':', e.message);
          property.coordinates = null;
        }
      }
      if (property.photos) {
        try {
          property.photos = JSON.parse(property.photos);
        } catch (e) {
          console.warn('⚠️ Ошибка парсинга photos для property ID', id, ':', e.message);
          property.photos = [];
        }
      }
      if (property.videos) {
        try {
          property.videos = JSON.parse(property.videos);
        } catch (e) {
          console.warn('⚠️ Ошибка парсинга videos для property ID', id, ':', e.message);
          property.videos = [];
        }
      }
      if (property.additional_documents) {
        try {
          property.additional_documents = JSON.parse(property.additional_documents);
        } catch (e) {
          console.warn('⚠️ Ошибка парсинга additional_documents для property ID', id, ':', e.message);
          property.additional_documents = [];
        }
      }
      if (property.test_drive_data) {
        try {
          property.test_drive_data = JSON.parse(property.test_drive_data);
        } catch (e) {
          console.warn('⚠️ Ошибка парсинга test_drive_data для property ID', id, ':', e.message);
          property.test_drive_data = null;
        }
      }
    }
    
    return property;
  },

  /**
   * Получить все квартиры/апартаменты пользователя
   */
  getByUserId: (userId, limit = 50, offset = 0) => {
    const db = getDatabase();
    const stmt = db.prepare(`
      SELECT * FROM properties_apartments 
      WHERE user_id = ? 
      ORDER BY created_at DESC 
      LIMIT ? OFFSET ?
    `);
    const properties = stmt.all(userId, limit, offset);
    
    // Парсим JSON поля для каждого объекта
    return properties.map(property => {
      if (property.amenities) property.amenities = JSON.parse(property.amenities);
      if (property.coordinates) property.coordinates = JSON.parse(property.coordinates);
      if (property.photos) property.photos = JSON.parse(property.photos);
      if (property.videos) property.videos = JSON.parse(property.videos);
      if (property.additional_documents) property.additional_documents = JSON.parse(property.additional_documents);
      if (property.test_drive_data) property.test_drive_data = JSON.parse(property.test_drive_data);
      return property;
    });
  },

  /**
   * Получить все квартиры/апартаменты с фильтрами
   */
  getAll: (filters = {}, limit = 100, offset = 0) => {
    const db = getDatabase();
    let query = 'SELECT * FROM properties_apartments WHERE 1=1';
    const params = [];
    
    if (filters.moderation_status) {
      query += ' AND moderation_status = ?';
      params.push(filters.moderation_status);
    }
    
    if (filters.property_type) {
      query += ' AND property_type = ?';
      params.push(filters.property_type);
    }
    
    if (filters.city) {
      query += ' AND city = ?';
      params.push(filters.city);
    }
    
    if (filters.country) {
      query += ' AND country = ?';
      params.push(filters.country);
    }
    
    query += ' ORDER BY created_at DESC LIMIT ? OFFSET ?';
    params.push(limit, offset);
    
    const stmt = db.prepare(query);
    const properties = stmt.all(...params);
    
    // Парсим JSON поля
    return properties.map(property => {
      if (property.amenities) property.amenities = JSON.parse(property.amenities);
      if (property.coordinates) property.coordinates = JSON.parse(property.coordinates);
      if (property.photos) property.photos = JSON.parse(property.photos);
      if (property.videos) property.videos = JSON.parse(property.videos);
      if (property.additional_documents) property.additional_documents = JSON.parse(property.additional_documents);
      if (property.test_drive_data) property.test_drive_data = JSON.parse(property.test_drive_data);
      return property;
    });
  },

  /**
   * Обновить квартиру/апартамент
   */
  update: (id, propertyData) => {
    const db = getDatabase();
    
    // Формируем JSON массив удобств
    const amenities = [];
    if (propertyData.balcony) amenities.push('balcony');
    if (propertyData.parking) amenities.push('parking');
    if (propertyData.elevator) amenities.push('elevator');
    if (propertyData.electricity) amenities.push('electricity');
    if (propertyData.internet) amenities.push('internet');
    if (propertyData.security) amenities.push('security');
    if (propertyData.furniture) amenities.push('furniture');
    
    for (let i = 1; i <= 26; i++) {
      const featureKey = `feature${i}`;
      if (propertyData[featureKey]) {
        amenities.push(featureKey);
      }
    }
    
    const stmt = db.prepare(`
      UPDATE properties_apartments SET
        title = ?, description = ?, price = ?, currency = ?,
        is_auction = ?, auction_start_date = ?, auction_end_date = ?, auction_starting_price = ?,
        area = ?, living_area = ?, building_type = ?, rooms = ?, bathrooms = ?, 
        floor = ?, total_floors = ?, year_built = ?,
        location = ?, address = ?, apartment = ?, country = ?, city = ?, coordinates = ?,
        amenities = ?, renovation = ?, condition = ?, heating = ?, water_supply = ?, sewerage = ?,
        commercial_type = ?, business_hours = ?, additional_amenities = ?,
        photos = ?, videos = ?, additional_documents = ?,
        ownership_document = ?, no_debts_document = ?,
        test_drive = ?, test_drive_data = ?,
        updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `);
    
    return stmt.run(
      propertyData.title,
      propertyData.description || null,
      propertyData.price || null,
      propertyData.currency || 'USD',
      propertyData.is_auction ? 1 : 0,
      propertyData.auction_start_date || null,
      propertyData.auction_end_date || null,
      propertyData.auction_starting_price || null,
      propertyData.area || null,
      propertyData.living_area || null,
      propertyData.building_type || null,
      propertyData.rooms || null,
      propertyData.bathrooms || null,
      propertyData.floor || null,
      propertyData.total_floors || null,
      propertyData.year_built || null,
      propertyData.location || null,
      propertyData.address || null,
      propertyData.apartment || null,
      propertyData.country || null,
      propertyData.city || null,
      propertyData.coordinates ? JSON.stringify(propertyData.coordinates) : null,
      JSON.stringify(amenities),
      propertyData.renovation || null,
      propertyData.condition || null,
      propertyData.heating || null,
      propertyData.water_supply || null,
      propertyData.sewerage || null,
      propertyData.commercial_type || null,
      propertyData.business_hours || null,
      propertyData.additional_amenities || null,
      propertyData.photos ? JSON.stringify(propertyData.photos) : null,
      propertyData.videos ? JSON.stringify(propertyData.videos) : null,
      propertyData.additional_documents ? JSON.stringify(propertyData.additional_documents) : null,
      propertyData.ownership_document || null,
      propertyData.no_debts_document || null,
      propertyData.test_drive ? 1 : 0,
      propertyData.test_drive_data ? JSON.stringify(propertyData.test_drive_data) : null,
      id
    );
  },

  /**
   * Удалить квартиру/апартамент
   */
  delete: (id) => {
    const db = getDatabase();
    const stmt = db.prepare('DELETE FROM properties_apartments WHERE id = ?');
    return stmt.run(id);
  },

  /**
   * Обновить статус модерации
   */
  updateModerationStatus: (id, status, reviewedBy = null, rejectionReason = null) => {
    const db = getDatabase();
    const stmt = db.prepare(`
      UPDATE properties_apartments 
      SET moderation_status = ?, reviewed_by = ?, reviewed_at = CURRENT_TIMESTAMP, rejection_reason = ?
      WHERE id = ?
    `);
    return stmt.run(status, reviewedBy, rejectionReason, id);
  },

  /**
   * Забронировать объект на 72 часа
   */
  reserve: (id, userId, purchaseRequestId) => {
    const db = getDatabase();
    const reservedUntil = new Date(Date.now() + 72 * 60 * 60 * 1000).toISOString(); // +72 часа
    const stmt = db.prepare(`
      UPDATE properties_apartments 
      SET reserved_until = ?, reserved_by = ?, purchase_request_id = ?
      WHERE id = ?
    `);
    return stmt.run(reservedUntil, userId, purchaseRequestId, id);
  },

  /**
   * Снять бронь с объекта
   */
  unreserve: (id) => {
    const db = getDatabase();
    const stmt = db.prepare(`
      UPDATE properties_apartments 
      SET reserved_until = NULL, reserved_by = NULL, purchase_request_id = NULL
      WHERE id = ?
    `);
    return stmt.run(id);
  },

  /**
   * Проверить, забронирован ли объект
   */
  isReserved: (id) => {
    const db = getDatabase();
    const stmt = db.prepare(`
      SELECT reserved_until, reserved_by, purchase_request_id 
      FROM properties_apartments 
      WHERE id = ?
    `);
    const result = stmt.get(id);
    
    if (!result || !result.reserved_until) {
      return { isReserved: false };
    }
    
    const reservedUntil = new Date(result.reserved_until);
    const now = new Date();
    
    // Если бронь истекла, автоматически снимаем её
    if (reservedUntil < now) {
      apartmentQueries.unreserve(id);
      return { isReserved: false };
    }
    
    return {
      isReserved: true,
      reservedUntil: result.reserved_until,
      reservedBy: result.reserved_by,
      purchaseRequestId: result.purchase_request_id,
      timeRemaining: reservedUntil - now
    };
  }
};
