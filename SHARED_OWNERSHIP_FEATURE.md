# Функционал долевой продажи недвижимости

## Описание
Добавлен полный функционал для продажи недвижимости по долям. Продавец может разбить объект на несколько долей, которые покупатели могут выкупать по отдельности.

## Что было реализовано

### 1. База данных
- **Файл**: `server/database/add_shared_ownership_fields.sql`
- **Изменения в таблицах**:
  - `properties_apartments` и `properties_houses`:
    - `is_shared_ownership` (INTEGER) - флаг долевой продажи
    - `total_shares` (INTEGER) - общее количество долей
    - `shares_sold` (INTEGER) - количество проданных долей
  
- **Новая таблица**: `property_shares`
  - Хранит информацию о каждой покупке долей
  - Поля: id, property_id, property_type, buyer_id, shares_count, price_per_share, total_price, currency, purchase_date, status
  - Индексы для быстрого поиска по объекту, покупателю и статусу

### 2. Backend API
- **Файл**: `server/database/database.js`
- **Новые функции**: `propertySharesQueries`
  - `create()` - создание записи о покупке долей
  - `getByProperty()` - получение всех покупок долей объекта
  - `getByBuyer()` - получение покупок долей пользователя
  - `getBuyerSharesCount()` - подсчет долей покупателя
  - `updatePropertySharesSold()` - обновление количества проданных долей
  - `getPropertySharesStats()` - статистика по долям объекта

- **Файл**: `server/server.js`
- **Новые endpoints**:
  - `POST /api/property-shares` - покупка долей
  - `GET /api/property-shares/:propertyType/:propertyId` - информация о долях объекта
  - `GET /api/property-shares/buyer/:buyerId` - доли, купленные пользователем
  - `GET /api/property-shares/:propertyType/:propertyId/stats` - статистика по долям

### 3. Frontend - Форма добавления объекта
- **Файл**: `src/pages/AddProperty.jsx`
- **Новый шаг**: "shared-ownership-question"
  - Появляется после выбора типа недвижимости
  - Продавец выбирает: долевая продажа или обычная
  
- **Поля в форме**:
  - `isSharedOwnership` - флаг долевой продажи
  - `totalShares` - количество долей
  - Автоматический расчет цены за долю
  - Визуальное отображение цены за долю
  
- **Ограничения**:
  - Для долевой продажи недоступен аукцион
  - Только прямая продажа

### 4. Frontend - Страница объекта
- **Файл**: `src/pages/PropertyDetailClassic.jsx`
- **Новый компонент**: `BuySharesModal`
- **Отображение**:
  - Бейдж "Долевая продажа"
  - Общая стоимость объекта
  - Количество всего долей
  - Количество доступных долей
  - Цена за одну долю
  - Прогресс-бар продаж
  - Кнопка "Купить доли"

### 5. Модальное окно покупки долей
- **Файлы**: 
  - `src/components/BuySharesModal.jsx`
  - `src/components/BuySharesModal.css`
  
- **Функционал**:
  - Выбор количества долей для покупки
  - Быстрые кнопки (1, 5, 10, Все)
  - Автоматический расчет итоговой суммы
  - Проверка доступности долей
  - Обработка покупки через API
  - Уведомление об успешной покупке

### 6. Стили
- **Файл**: `src/pages/PropertyDetailClassic.css`
- Добавлены стили для:
  - Бейджа долевой продажи
  - Блока информации о долях
  - Прогресс-бара
  - Кнопки покупки долей

## Как использовать

### Для продавца:
1. Перейти в "Добавить объявление"
2. Выбрать тип недвижимости
3. На вопрос "Это долевая продажа?" ответить "Да"
4. Заполнить обычные данные объекта
5. На шаге "Укажите стоимость":
   - Указать общую стоимость объекта
   - Указать количество долей (например, 50)
   - Система автоматически рассчитает цену за долю
6. Опубликовать объект

### Для покупателя:
1. Открыть объект с долевой продажей
2. Увидеть информацию о долях:
   - Общую стоимость
   - Количество всего долей
   - Количество доступных долей
   - Цену за долю
3. Нажать "Купить доли"
4. В модальном окне:
   - Выбрать количество долей
   - Увидеть итоговую сумму
   - Подтвердить покупку
5. После покупки стать совладельцем объекта

## Примеры

### Пример 1: Квартира за 20 миллионов на 50 долей
- Общая стоимость: $20,000,000
- Количество долей: 50
- Цена за долю: $400,000
- Покупатель может купить от 1 до 50 долей

### Пример 2: Вилла за 10 миллионов на 100 долей
- Общая стоимость: €10,000,000
- Количество долей: 100
- Цена за долю: €100,000
- Покупатель может купить от 1 до 100 долей

## Технические детали

### Валидация
- Минимум 2 доли
- Максимум 1000 долей
- Нельзя купить больше доступных долей
- Автоматическое обновление количества проданных долей

### Безопасность
- Проверка авторизации покупателя
- Проверка доступности долей перед покупкой
- Транзакционная целостность данных
- Индексы для быстрого доступа

### Производительность
- Индексы на всех ключевых полях
- Оптимизированные запросы
- Кэширование статистики долей

## Будущие улучшения
- Уведомления продавцу о покупке долей
- История покупок долей в личном кабинете
- Возможность перепродажи долей
- Аналитика по долевым объектам
- Экспорт данных о совладельцах

## Миграция данных
При первом запуске сервера автоматически:
1. Добавятся новые поля в таблицы недвижимости
2. Создастся таблица `property_shares`
3. Создадутся необходимые индексы

Все существующие объекты останутся без изменений (is_shared_ownership = 0).
