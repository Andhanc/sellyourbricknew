# Настройка авторизации через WhatsApp

## Описание

Реализована авторизация через WhatsApp бота. Пользователь вводит номер телефона, получает код в WhatsApp, вводит код на сайте и авторизуется.

## Варианты реализации

### Вариант 1: Green API (Рекомендуется для начала)

**Бесплатно:** до 100 сообщений в день

#### Шаг 1: Регистрация в Green API

1. Перейдите на [Green API](https://green-api.com/)
2. Зарегистрируйтесь и создайте новый инстанс
3. Получите `idInstance` и `apiTokenInstance` из личного кабинета

#### Шаг 2: Настройка переменных окружения

1. Создайте файл `.env` в корне проекта (если его еще нет)
2. Добавьте следующие переменные:

```env
VITE_GREEN_API_URL=https://7105.api.greenapi.com
VITE_GREEN_API_ID=7105458006
VITE_GREEN_API_TOKEN=cd0b90b23ee340cba0e7a90767355c44af7da8df155342a8bb
```

**Важно:**
- В Vite переменные окружения должны начинаться с `VITE_`
- Никогда не коммитьте файл `.env` в git (он уже должен быть в `.gitignore`)
- Для production используйте переменные окружения вашего хостинга

#### Шаг 3: Подключение WhatsApp аккаунта

1. В личном кабинете Green API найдите QR-код для подключения
2. Откройте WhatsApp на телефоне
3. Перейдите в Настройки → Связанные устройства → Связать устройство
4. Отсканируйте QR-код из личного кабинета

#### Шаг 4: Проверка работы

1. Запустите dev сервер: `npm run dev`
2. Откройте модальное окно входа/регистрации
3. Нажмите кнопку "Войти через WhatsApp"
4. Введите номер телефона
5. Проверьте WhatsApp - должен прийти код
6. Введите код на сайте
7. После успешной авторизации вы будете перенаправлены на страницу профиля

### Вариант 2: Whapi (Альтернатива)

**Бесплатно:** до 5 активных чатов в месяц, 150 сообщений в день

1. Зарегистрируйтесь на [Whapi](https://whapi.cloud/)
2. Получите API ключ
3. Обновите код в `authService.js` для использования Whapi API

### Вариант 3: Backend сервер (Для production)

Для production рекомендуется создать backend сервер, который будет:
- Генерировать коды верификации
- Хранить коды в базе данных
- Принимать вебхуки от WhatsApp API
- Проверять коды и авторизовывать пользователей

#### Пример структуры backend (Node.js/Express):

```javascript
// server.js
const express = require('express');
const app = express();

// Хранилище кодов (в production используйте базу данных)
const verificationCodes = new Map();

// Генерация кода
app.post('/api/auth/whatsapp/send-code', async (req, res) => {
  const { phone } = req.body;
  const code = Math.floor(100000 + Math.random() * 900000).toString();
  
  // Сохраняем код
  verificationCodes.set(phone, {
    code,
    expiresAt: Date.now() + 10 * 60 * 1000 // 10 минут
  });
  
  // Отправляем через WhatsApp API
  // ... код отправки через Green API или другой сервис
  
  res.json({ success: true });
});

// Проверка кода
app.post('/api/auth/whatsapp/verify', async (req, res) => {
  const { phone, code } = req.body;
  const stored = verificationCodes.get(phone);
  
  if (!stored || stored.code !== code || Date.now() > stored.expiresAt) {
    return res.status(400).json({ success: false, error: 'Неверный код' });
  }
  
  // Удаляем код
  verificationCodes.delete(phone);
  
  // Создаем/находим пользователя
  // ... код работы с базой данных
  
  res.json({ success: true, user: userData });
});
```

## Как это работает

1. **Пользователь нажимает "Войти через WhatsApp"**
   - Открывается модальное окно для ввода номера телефона

2. **Пользователь вводит номер телефона**
   - Номер форматируется (убираются лишние символы, добавляется код страны)
   - Генерируется уникальный 6-значный код
   - Код сохраняется в localStorage (временное решение) или отправляется на backend

3. **Отправка кода через WhatsApp**
   - Если настроен Green API, код отправляется автоматически
   - Если нет, открывается WhatsApp с предзаполненным сообщением (для демо)

4. **Пользователь вводит код**
   - Код проверяется на соответствие
   - Если код верный, пользователь авторизуется
   - Данные пользователя сохраняются в localStorage

5. **Авторизация завершена**
   - Пользователь перенаправляется на страницу профиля

## Безопасность

⚠️ **Важно для production:**

1. **Коды должны храниться на backend**, а не в localStorage
2. **Коды должны иметь ограниченное время жизни** (например, 10 минут)
3. **Ограничьте количество попыток** ввода кода (например, 3 попытки)
4. **Используйте rate limiting** для предотвращения спама
5. **Валидируйте номера телефонов** на backend
6. **Используйте HTTPS** для всех запросов

## Решение проблем

### Код не приходит в WhatsApp

1. Проверьте, что Green API инстанс подключен к WhatsApp
2. Проверьте правильность `idInstance` и `apiTokenInstance`
3. Убедитесь, что номер телефона введен в правильном формате
4. Проверьте лимиты бесплатного тарифа (100 сообщений/день для Green API)

### Ошибка 466 при отправке сообщения

**⚠️ ВАЖНО:** GreenAPI (обычный WhatsApp API) требует, чтобы номер получателя был **добавлен в контакты** WhatsApp аккаунта, подключенного к GreenAPI.

**Причина ошибки 466:**
- Номер получателя не находится в контактах WhatsApp аккаунта GreenAPI
- Это ограничение обычного WhatsApp API (не Business API)

**Решение для тестирования:**
1. Откройте WhatsApp на телефоне, подключенном к GreenAPI
2. Добавьте номер получателя в контакты
3. Попробуйте отправить код снова

**Решение для production:**
- Используйте **WhatsApp Business API** (позволяет отправлять сообщения без контактов, но требует верификации бизнеса)
- Или используйте альтернативные сервисы (Twilio, MessageBird, Vonage и т.д.)
- Или используйте текущий fallback механизм (открытие WhatsApp с предзаполненным сообщением)

### Ошибка "Неверный код"

1. Убедитесь, что код введен полностью (6 цифр)
2. Проверьте, что код не истек (действителен 10 минут)
3. Попробуйте запросить новый код

### WhatsApp не открывается

1. Проверьте, что на устройстве установлен WhatsApp
2. Убедитесь, что номер телефона введен корректно
3. В production используйте backend для отправки сообщений

## Дополнительные возможности

### Интеграция с базой данных

В production рекомендуется:
- Сохранять пользователей в базе данных
- Хранить историю авторизаций
- Связывать номера телефонов с аккаунтами пользователей

### Двухфакторная аутентификация

Можно использовать WhatsApp авторизацию как второй фактор для других методов входа (email, Google, Facebook).

### Уведомления

Можно настроить отправку уведомлений через WhatsApp о важных событиях (новые объявления, ставки и т.д.).

## Примечания

- В текущей реализации коды хранятся в localStorage (только для разработки)
- Для production необходимо создать backend сервер
- Green API имеет бесплатный tier с ограничениями
- Для больших объемов рассмотрите платные тарифы или собственный сервер

